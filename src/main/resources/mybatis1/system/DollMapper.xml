<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="DollMapper">



	<resultMap type="DollVo" id="DollVoResultMap">
		<result column="DOLL_ID" property="dollId"/>
		<result column="DOLL_SN" property="dollSn"/>	
		<result column="DOLL_NAME" property="dollName"/>	
		<result column="ROOM_ID" property="roomId"/>
		<result column="DOLL_STATE" property="dollState"/>
		<result column="DOLL_GOLD" property="dollGold"/>
		<result column="DOLL_URL" property="dollUrl"/>
		<result column="DOLL_CONVERSIONGOLD" property="dollConversiongold"/>
		<result column="CAMERA_NAME_01" property="cameraName01"/>
		<result column="CAMERA_NAME_02" property="cameraName02"/>
		<!-- <result column="TOY_ID" property="toy_id"/> -->
			
		<collection property="cameras" column="DOLL_ID" ofType="com.fh.vo.system.CameraVo">
	        <id property="cameraId" column="CAMERA_ID"/>
	        <result property="rtmpUrl" column="RTMP_URL"/>
	        <result property="serverName" column="SERVER_NAME"/>
	        <result property="livestream" column="LIVESTREAM"/>
	        <result property="cameraType" column="CAMERA_TYPE"/>
	        <result property="deviceState" column="DEVICE_STATE"/>
	    </collection>
	</resultMap>

    <!--表名 -->
    <sql id="tableName">
		SYS_APP_DOLL
	</sql>

    <sql id="gatewayTableName">
        TBL_GATEWAY_SESSION
    </sql>

    <!-- 字段 -->
    <sql id="Field">
		DOLL_SN,	
		DOLL_NAME,	
		ROOM_ID,	
		DOLL_STATE,	
		DOLL_ID,
		DOLL_GOLD,
		DOLL_URL,
		DOLL_CONVERSIONGOLD,
		CAMERA_NAME_01,
		CAMERA_NAME_02,
		TOY_ID,
		RELEASE_STATUS
	</sql>

    <!-- 字段值 -->
    <sql id="FieldValue">
		#{DOLL_SN},	
		#{DOLL_NAME},	
		#{ROOM_ID},	
		#{DOLL_STATE},	
		#{DOLL_ID},
		#{DOLL_GOLD},
		#{DOLL_URL},
		#{DOLL_CONVERSIONGOLD},
		#{CAMERA_NAME_01},
		#{CAMERA_NAME_02},
		#{TOY_ID},
		#{RELEASE_STATUS}
	</sql>

    <!-- 新增-->
    <insert id="save" parameterType="pd">
        insert into
        <include refid="tableName"></include>
        (
        <include refid="Field"></include>
        ) values (
        <include refid="FieldValue"></include>
        )
    </insert>

    <!-- 删除-->
    <delete id="delete" parameterType="pd">
        delete from
        <include refid="tableName"></include>
        where
        DOLL_ID = #{DOLL_ID}
    </delete>

    <!-- 修改 -->
    <update id="edit" parameterType="pd">
        update
        <include refid="tableName"></include>
        set
        DOLL_NAME = #{DOLL_NAME},
        DOLL_SN = #{DOLL_SN},
        DOLL_GOLD = #{DOLL_GOLD},
        DOLL_CONVERSIONGOLD = #{DOLL_CONVERSIONGOLD},
        RELEASE_STATUS = #{RELEASE_STATUS},
        DOLL_URL = #{DOLL_URL},
        TOY_ID = #{TOY_ID}
        where
        DOLL_ID = #{DOLL_ID}
    </update>

    <!-- 通过ID获取数据 -->
    <select id="findById" parameterType="pd" resultType="pd">
        select
        <include refid="Field"></include>
        from
        <include refid="tableName"></include>
        where
        DOLL_ID = #{DOLL_ID}
    </select>

    <!-- 列表 -->
    <select id="dolllistPage" parameterType="page" resultType="pd">
        select
        <include refid="Field"></include>
        from
        <include refid="tableName"></include>
        where 1=1
        <if test="pd.keywords!= null and pd.keywords != ''"><!-- 关键词检索 -->
            and
            DOLL_NAME LIKE CONCAT(CONCAT('%', #{pd.keywords}),'%')
        </if>
        <if test="pd.DOLL_STATE != null and pd.DOLL_STATE != ''"><!-- 状态检索 -->
            and DOLL_STATE = #{pd.DOLL_STATE}
        </if>
         <if test="pd.RELEASE_STATUS != null and pd.RELEASE_STATUS == 0"><!-- 未发布状态检索 -->
        	 and ( RELEASE_STATUS ='0' or RELEASE_STATUS is null )
       
        </if>
        <if test="pd.RELEASE_STATUS != null and pd.RELEASE_STATUS == 1"><!-- 已发布状态检索 -->
        	 and RELEASE_STATUS ='1'
        </if>

    </select>

    <!-- 列表(全部) -->
    <select id="listAllPage" parameterType="pd" resultType="pd">
        select
        <include refid="Field"></include>
        from
        <include refid="tableName"></include>
    </select>

    <!-- 批量删除 -->
    <delete id="deleteAll" parameterType="String">
        delete from
        <include refid="tableName"></include>
        where
        DOLL_ID in
        <foreach item="item" index="index" collection="array" open="(" separator="," close=")">
            #{item}
        </foreach>
    </delete>

    <!--根据娃娃机sn号获取娃娃机对象-->
    <select id="getDollBySN" parameterType="String" resultType="com.fh.entity.system.Doll">
        SELECT
        <include refid="Field"/>
        FROM
        <include refid="tableName"/>
        WHERE
        DOLL_SN = #{DOLL_SN}

    </select>

    <!--根据娃娃机状态码获取娃娃机空闲中对象-->
    <select id="getDollByState" parameterType="String" resultType="com.fh.entity.system.Doll">
        SELECT
        <include refid="Field"/>
        FROM
        <include refid="tableName"/>
        WHERE
        DOLL_STATE =#{DOLL_STATE}

    </select>

    <!--通过ID获取娃娃机信息-->
    <select id="getDollByID" parameterType="String" resultType="com.fh.entity.system.Doll">
        SELECT
        <include refid="Field"/>
        FROM
        <include refid="tableName"/>
        WHERE
        DOLL_ID =#{DOLL_ID}

    </select>

    <!--获取娃娃机在线信息-->
    <select id="getAllDoll" parameterType="String" resultType="com.fh.entity.system.Doll">
        SELECT
        <include refid="Field"/>
        FROM
        <include refid="tableName"/>
    </select>
    <!--通过SN号注册娃娃机-->
    <insert id="regDollBySN" parameterType="String">
        insert into
        <include refid="tableName"/>
        (
        DOLL_ID,
        DOLL_SN
        ) values (
        #{DOLL_ID},
        #{DOLL_SN}
        )

    </insert>
    <!--通过doll_id查询娃娃机-->
    <select id="getDollBySessionOnLine" parameterType="String" resultType="Doll">
        SELECT
        d.DOLL_SN,
        d.DOLL_NAME,
        d.DOLL_ID,
        d.DOLL_GOLD,
        d.DOLL_URL
        FROM
        <include refid="tableName"/>
        d
        INNER JOIN
        <include refid="gatewayTableName"/>
        g
        ON
        d.Doll_ID = g.ROOM_ID
    </select>

    <!-- 通过娃娃机的名字获取娃娃信息-->
    <select id="getDollByDollName" parameterType="String" resultType="Doll">
        SELECT
        *
        FROM
        <include refid="tableName"/>
        WHERE
        DOLL_NAME = #{DOLL_NAME}
    </select>


    <!-- 通过娃娃机的名字获取娃娃信息-->
    <select id="getDollVoList" resultMap="DollVoResultMap">
        SELECT
	    	d.DOLL_SN,	
			d.DOLL_NAME,	
			d.ROOM_ID,	
			d.DOLL_STATE,	
			d.DOLL_ID,
			d.DOLL_GOLD,
			d.DOLL_URL,
			d.DOLL_CONVERSIONGOLD,
			c.CAMERA_ID,
			c.CAMERA_TYPE,
			c.RTMP_URL,
			c.SERVER_NAME,
			c.LIVESTREAM,
			c.DEVICE_STATE from
			SYS_APP_DOLL d LEFT JOIN TB_DEVICE_CAMERA c ON d.DOLL_ID=c.DOLL_ID
			WHERE d.RELEASE_STATUS ='1'
    </select>

</mapper>